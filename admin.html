<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin Completo</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Georgia', serif; background-color: #f5f5f0; color: #2c2c2c; padding: 20px; }
  .admin-container { max-width: 1200px; margin: 20px auto; background: white; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-radius: 8px; }
  h1, h2, h3 { margin-bottom: 20px; }
  h1 { text-align: center; }
  
  /* Login */
  #login-form input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
  #login-form button { width: 100%; padding: 12px; margin-top: 10px; background-color: #333; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
  #login-form button:hover { background-color: #555; }
  #loginError { color: red; margin-top: 10px; }

  /* Tabs */
  .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #eee; }
  .tab { padding: 12px 24px; cursor: pointer; background: transparent; border: none; font-size: 16px; color: #666; transition: all 0.3s; }
  .tab.active { color: #333; font-weight: 600; border-bottom: 3px solid #333; }
  .tab:hover { background: #fafafa; }
  
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Categor√≠as */
  .categoria-item { display: flex; align-items: center; gap: 15px; padding: 15px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; background: #fafafa; }
  .categoria-item.inactiva { opacity: 0.5; background: #f0f0f0; }
  .drag-handle { cursor: move; font-size: 20px; color: #999; }
  .categoria-nombre { flex: 1; font-weight: 600; }
  .categoria-actions { display: flex; gap: 8px; }
  .categoria-actions button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
  .btn-editar { background-color: #3498db; color: white; }
  .btn-editar:hover { background-color: #2980b9; }
  .btn-toggle { background-color: #f39c12; color: white; }
  .btn-toggle:hover { background-color: #e67e22; }
  .btn-eliminar { background-color: #e74c3c; color: white; }
  .btn-eliminar:hover { background-color: #c0392b; }

  /* Formularios */
  .form-box { background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 30px; }
  .form-box input, .form-box select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; }
  .form-box button { padding: 10px 20px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
  .form-box button:hover { background-color: #2ecc71; }
  .form-box button.cancel { background-color: #95a5a6; margin-left: 10px; }
  .form-box button.cancel:hover { background-color: #7f8c8d; }

  /* Platos */
  .platos-por-categoria { margin-bottom: 40px; }
  .platos-por-categoria h3 { border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 15px; }
  .plato-item { display: flex; align-items: center; gap: 15px; padding: 12px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; background: white; }
  .plato-item.inactivo { opacity: 0.5; background: #f9f9f9; }
  .plato-info { flex: 1; }
  .plato-nombre { font-weight: 600; color: #1a1a1a; }
  .plato-descripcion { font-size: 14px; color: #666; margin-top: 4px; }
  .plato-precio { font-weight: 600; color: #27ae60; white-space: nowrap; margin-right: 15px; }
  .plato-actions { display: flex; gap: 8px; }
  .plato-actions button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }

  #logoutBtn { margin-top: 30px; background-color: #333; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
  #logoutBtn:hover { background-color: #555; }

  .empty-state { text-align: center; padding: 40px; color: #999; font-style: italic; }
</style>
</head>
<body>

<div class="admin-container">
  <h1>üçΩÔ∏è Panel de Administraci√≥n</h1>

  <div id="login-form">
    <h2 style="text-align: center; margin-bottom: 20px;">Iniciar Sesi√≥n</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Contrase√±a">
    <button id="loginBtn">Entrar</button>
    <p id="loginError"></p>
  </div>

  <div id="admin-panel" style="display:none;">
    <div class="tabs">
      <button class="tab active" data-tab="categorias">Categor√≠as</button>
      <button class="tab" data-tab="platos">Platos</button>
    </div>

    <!-- TAB CATEGOR√çAS -->
    <div id="tab-categorias" class="tab-content active">
      <div class="form-box">
        <h3 id="categoria-form-title">‚ûï Nueva Categor√≠a</h3>
        <input type="hidden" id="editCategoriaId">
        <input id="categoriaNombre" placeholder="Nombre de la categor√≠a">
        <button id="guardarCategoriaBtn">Guardar</button>
        <button class="cancel" id="cancelCategoriaBtn" style="display:none;">Cancelar</button>
      </div>

      <div id="categoriasContainer"></div>
    </div>

    <!-- TAB PLATOS -->
    <div id="tab-platos" class="tab-content">
      <div class="form-box">
        <h3 id="plato-form-title">‚ûï Nuevo Plato</h3>
        <input type="hidden" id="editPlatoId">
        <input id="platoNombre" placeholder="Nombre del plato">
        <input id="platoDescripcion" placeholder="Descripci√≥n">
        <input id="platoPrecio" type="number" step="0.01" placeholder="Precio (‚Ç¨)">
        <select id="platoCategoria"></select>
        <button id="guardarPlatoBtn">Guardar</button>
        <button class="cancel" id="cancelPlatoBtn" style="display:none;">Cancelar</button>
      </div>

      <div id="platosContainer"></div>
    </div>

    <button id="logoutBtn">Cerrar Sesi√≥n</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://qozzxdrjwjskmwmxscqj.supabase.co'
const supabaseKey = 'sb_publishable_UtBfupVv8e2zniYdv1jvEA_SXIyWE0Z'
const supabase = createClient(supabaseUrl, supabaseKey)

let user = null

// LOGIN
document.getElementById('loginBtn').onclick = async () => {
  const email = document.getElementById('email').value
  const password = document.getElementById('password').value
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) { 
    document.getElementById('loginError').textContent = error.message
    return
  }
  user = data.user
  document.getElementById('login-form').style.display = 'none'
  document.getElementById('admin-panel').style.display = 'block'
  cargarTodo()
}

// LOGOUT
document.getElementById('logoutBtn').onclick = async () => {
  await supabase.auth.signOut()
  location.reload()
}

// TABS
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
    tab.classList.add('active')
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active')
  }
})

// ========== CATEGOR√çAS ==========

async function cargarCategorias() {
  const { data: categorias } = await supabase
    .from('Categorias')
    .select('*')
    .eq('user_id', user.id)
    .order('orden', { ascending: true })

  const container = document.getElementById('categoriasContainer')
  container.innerHTML = ''

  if (!categorias || categorias.length === 0) {
    container.innerHTML = '<div class="empty-state">No hay categor√≠as. ¬°Crea la primera!</div>'
    return
  }

  categorias.forEach(cat => {
    const div = document.createElement('div')
    div.className = 'categoria-item' + (cat.activa ? '' : ' inactiva')
    div.dataset.id = cat.id
    div.innerHTML = `
      <span class="drag-handle">‚ò∞</span>
      <div class="categoria-nombre">${cat.nombre} ${cat.activa ? '' : '(Desactivada)'}</div>
      <div class="categoria-actions">
        <button class="btn-editar" data-id="${cat.id}">‚úèÔ∏è Editar</button>
        <button class="btn-toggle" data-id="${cat.id}">${cat.activa ? 'üëÅÔ∏è Ocultar' : 'üëÅÔ∏è Mostrar'}</button>
        <button class="btn-eliminar" data-id="${cat.id}">üóëÔ∏è Eliminar</button>
      </div>
    `
    container.appendChild(div)
  })

  // Eventos
  container.querySelectorAll('.btn-editar').forEach(btn => {
    btn.onclick = () => editarCategoria(btn.dataset.id, categorias)
  })
  container.querySelectorAll('.btn-toggle').forEach(btn => {
    btn.onclick = () => toggleCategoria(btn.dataset.id, categorias)
  })
  container.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.onclick = () => eliminarCategoria(btn.dataset.id)
  })

  // Drag and drop para reordenar
  makeSortable(container, categorias)

  // Actualizar select de categor√≠as en platos
  actualizarSelectCategorias(categorias)
}

function makeSortable(container, categorias) {
  let draggedElement = null

  container.querySelectorAll('.categoria-item').forEach(item => {
    item.draggable = true
    
    item.ondragstart = (e) => {
      draggedElement = item
      item.style.opacity = '0.5'
    }
    
    item.ondragend = () => {
      item.style.opacity = '1'
      draggedElement = null
    }
    
    item.ondragover = (e) => {
      e.preventDefault()
    }
    
    item.ondrop = async (e) => {
      e.preventDefault()
      if (draggedElement && draggedElement !== item) {
        const allItems = [...container.querySelectorAll('.categoria-item')]
        const draggedIndex = allItems.indexOf(draggedElement)
        const targetIndex = allItems.indexOf(item)
        
        if (draggedIndex < targetIndex) {
          item.after(draggedElement)
        } else {
          item.before(draggedElement)
        }
        
        // Actualizar orden en BD
        await actualizarOrdenCategorias(container)
      }
    }
  })
}

async function actualizarOrdenCategorias(container) {
  const items = [...container.querySelectorAll('.categoria-item')]
  for (let i = 0; i < items.length; i++) {
    const id = items[i].dataset.id
    await supabase.from('Categorias').update({ orden: i }).eq('id', id)
  }
}

function editarCategoria(id, categorias) {
  const cat = categorias.find(c => c.id == id)
  document.getElementById('editCategoriaId').value = id
  document.getElementById('categoriaNombre').value = cat.nombre
  document.getElementById('categoria-form-title').textContent = '‚úèÔ∏è Editar Categor√≠a'
  document.getElementById('cancelCategoriaBtn').style.display = 'inline-block'
}

async function toggleCategoria(id, categorias) {
  const cat = categorias.find(c => c.id == id)
  await supabase.from('Categorias').update({ activa: !cat.activa }).eq('id', id)
  cargarCategorias()
}

async function eliminarCategoria(id) {
  if (!confirm('¬øEliminar esta categor√≠a? Los platos asociados quedar√°n sin categor√≠a.')) return
  await supabase.from('Categorias').delete().eq('id', id)
  cargarCategorias()
  cargarPlatos()
}

document.getElementById('guardarCategoriaBtn').onclick = async () => {
  const nombre = document.getElementById('categoriaNombre').value.trim()
  if (!nombre) return alert('El nombre es obligatorio')

  const editId = document.getElementById('editCategoriaId').value

  if (editId) {
    await supabase.from('Categorias').update({ nombre }).eq('id', editId)
  } else {
    const { data: maxOrden } = await supabase
      .from('Categorias')
      .select('orden')
      .eq('user_id', user.id)
      .order('orden', { ascending: false })
      .limit(1)
    
    const nuevoOrden = maxOrden && maxOrden.length > 0 ? maxOrden[0].orden + 1 : 0

    await supabase.from('Categorias').insert({
      nombre,
      orden: nuevoOrden,
      user_id: user.id
    })
  }

  limpiarFormCategoria()
  cargarCategorias()
}

document.getElementById('cancelCategoriaBtn').onclick = limpiarFormCategoria

function limpiarFormCategoria() {
  document.getElementById('editCategoriaId').value = ''
  document.getElementById('categoriaNombre').value = ''
  document.getElementById('categoria-form-title').textContent = '‚ûï Nueva Categor√≠a'
  document.getElementById('cancelCategoriaBtn').style.display = 'none'
}

// ========== PLATOS ==========

async function cargarPlatos() {
  const { data: categorias } = await supabase
    .from('Categorias')
    .select('*')
    .eq('user_id', user.id)
    .order('orden')

  const { data: platos } = await supabase
    .from('Menu')
    .select('*')
    .eq('user_id', user.id)
    .order('orden')

  const container = document.getElementById('platosContainer')
  container.innerHTML = ''

  if (!categorias || categorias.length === 0) {
    container.innerHTML = '<div class="empty-state">Primero crea categor√≠as en la pesta√±a anterior.</div>'
    return
  }

  categorias.forEach(cat => {
    const catDiv = document.createElement('div')
    catDiv.className = 'platos-por-categoria'
    
    const catPlatos = platos.filter(p => p.categoria_id == cat.id)
    
    catDiv.innerHTML = `<h3>${cat.nombre}</h3>`
    
    if (catPlatos.length === 0) {
      catDiv.innerHTML += '<div class="empty-state">No hay platos en esta categor√≠a</div>'
    } else {
      catPlatos.forEach(plato => {
        const platoDiv = document.createElement('div')
        platoDiv.className = 'plato-item' + (plato.activo ? '' : ' inactivo')
        platoDiv.innerHTML = `
          <div class="plato-info">
            <div class="plato-nombre">${plato.plato} ${plato.activo ? '' : '(Desactivado)'}</div>
            ${plato.descripcion ? `<div class="plato-descripcion">${plato.descripcion}</div>` : ''}
          </div>
          ${plato.precio ? `<div class="plato-precio">${plato.precio}‚Ç¨</div>` : ''}
          <div class="plato-actions">
            <button class="btn-editar" data-id="${plato.id}">‚úèÔ∏è</button>
            <button class="btn-toggle" data-id="${plato.id}">${plato.activo ? 'üëÅÔ∏è' : '‚úì'}</button>
            <button class="btn-eliminar" data-id="${plato.id}">üóëÔ∏è</button>
          </div>
        `
        catDiv.appendChild(platoDiv)
      })
    }
    
    container.appendChild(catDiv)
  })

  // Eventos
  container.querySelectorAll('.btn-editar').forEach(btn => {
    btn.onclick = () => editarPlato(btn.dataset.id, platos)
  })
  container.querySelectorAll('.btn-toggle').forEach(btn => {
    btn.onclick = () => togglePlato(btn.dataset.id, platos)
  })
  container.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.onclick = () => eliminarPlato(btn.dataset.id)
  })
}

function editarPlato(id, platos) {
  const plato = platos.find(p => p.id == id)
  document.getElementById('editPlatoId').value = id
  document.getElementById('platoNombre').value = plato.plato
  document.getElementById('platoDescripcion').value = plato.descripcion || ''
  document.getElementById('platoPrecio').value = plato.precio || ''
  document.getElementById('platoCategoria').value = plato.categoria_id || ''
  document.getElementById('plato-form-title').textContent = '‚úèÔ∏è Editar Plato'
  document.getElementById('cancelPlatoBtn').style.display = 'inline-block'
  
  // Scroll al formulario
  document.getElementById('tab-platos').scrollIntoView({ behavior: 'smooth' })
}

async function togglePlato(id, platos) {
  const plato = platos.find(p => p.id == id)
  await supabase.from('Menu').update({ activo: !plato.activo }).eq('id', id)
  cargarPlatos()
}

async function eliminarPlato(id) {
  if (!confirm('¬øEliminar este plato?')) return
  await supabase.from('Menu').delete().eq('id', id)
  cargarPlatos()
}

document.getElementById('guardarPlatoBtn').onclick = async () => {
  const nombre = document.getElementById('platoNombre').value.trim()
  const descripcion = document.getElementById('platoDescripcion').value.trim()
  const precio = document.getElementById('platoPrecio').value
  const categoriaId = document.getElementById('platoCategoria').value

  if (!nombre) return alert('El nombre es obligatorio')
  if (!categoriaId) return alert('Selecciona una categor√≠a')

  const editId = document.getElementById('editPlatoId').value

  if (editId) {
    await supabase.from('Menu').update({
      plato: nombre,
      descripcion,
      precio: precio || null,
      categoria_id: categoriaId
    }).eq('id', editId)
  } else {
    const { data: maxOrden } = await supabase
      .from('Menu')
      .select('orden')
      .eq('user_id', user.id)
      .eq('categoria_id', categoriaId)
      .order('orden', { ascending: false })
      .limit(1)
    
    const nuevoOrden = maxOrden && maxOrden.length > 0 ? maxOrden[0].orden + 1 : 0

    await supabase.from('Menu').insert({
      plato: nombre,
      descripcion,
      precio: precio || null,
      categoria_id: categoriaId,
      user_id: user.id,
      orden: nuevoOrden,
      activo: true
    })
  }

  limpiarFormPlato()
  cargarPlatos()
}

document.getElementById('cancelPlatoBtn').onclick = limpiarFormPlato

function limpiarFormPlato() {
  document.getElementById('editPlatoId').value = ''
  document.getElementById('platoNombre').value = ''
  document.getElementById('platoDescripcion').value = ''
  document.getElementById('platoPrecio').value = ''
  document.getElementById('platoCategoria').value = ''
  document.getElementById('plato-form-title').textContent = '‚ûï Nuevo Plato'
  document.getElementById('cancelPlatoBtn').style.display = 'none'
}

function actualizarSelectCategorias(categorias) {
  const select = document.getElementById('platoCategoria')
  select.innerHTML = '<option value="">-- Selecciona categor√≠a --</option>'
  categorias.filter(c => c.activa).forEach(cat => {
    select.innerHTML += `<option value="${cat.id}">${cat.nombre}</option>`
  })
}

async function cargarTodo() {
  await cargarCategorias()
  await cargarPlatos()
}
</script>

</body>
</html>