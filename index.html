<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carta Digital</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body { 
    font-family: 'Georgia', serif; 
    background-color: #f5f5f0; 
    color: #2c2c2c; 
    padding: 20px; 
    min-height: 100vh; 
  }

  body::before { 
    content: ''; 
    position: fixed; 
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, #e0e0e0 1px, transparent 1px),
                linear-gradient(#e0e0e0 1px, transparent 1px);
    background-size: 20px 20px; 
    opacity: 0.3; 
    pointer-events: none; 
    z-index: -1; 
  }

  .container { 
    max-width: 800px; 
    width: 100%; 
    background: white; 
    padding: 60px 50px; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
    position: relative; 
    margin: 20px auto; 
  }

  .container::before { 
    content: ''; 
    position: absolute; 
    top: 30px; left: 30px; right: 30px; bottom: 30px; 
    border: 2px solid #333; 
    pointer-events: none; 
  }

  .container::after { 
    content: ''; 
    position: absolute; 
    top: 35px; left: 35px; right: 35px; bottom: 35px; 
    border: 1px solid #666; 
    pointer-events: none; 
  }

  header { 
    text-align: center; 
    margin-bottom: 50px; 
    position: relative; 
  }

  header::before { 
    content: '‚óÜ'; 
    display: block; 
    color: #333; 
    font-size: 1.2em; 
    margin-bottom: 15px; 
  }

  header h1 { 
    font-size: 2.5em; 
    color: #2c2c2c; 
    font-weight: 400; 
    letter-spacing: 4px; 
    margin-bottom: 10px; 
  }

  header p { 
    color: #666; 
    font-size: 1em; 
    font-style: italic; 
    letter-spacing: 1px; 
  }

  header::after { 
    content: '‚óÜ'; 
    display: block; 
    color: #333; 
    font-size: 1.2em; 
    margin-top: 15px; 
  }

  main { 
    position: relative; 
    z-index: 1; 
  }

  .menu-section { 
    margin-bottom: 20px; 
  }

  .collapsible { 
    width: 100%; 
    background: transparent; 
    color: #2c2c2c; 
    padding: 15px 20px; 
    border: none; 
    border-bottom: 1px solid #ddd;
    font-size: 1.2em; 
    font-weight: 400; 
    text-align: center; 
    cursor: pointer; 
    letter-spacing: 3px; 
    text-transform: uppercase; 
    font-family: 'Georgia', serif; 
    transition: all 0.3s ease; 
  }

  .collapsible:hover { 
    background: #fafafa; 
    color: #000; 
  }

  .collapsible.active { 
    background: #f5f5f5; 
    border-bottom: 2px solid #333; 
  }

  .content { 
    display: none; 
    background: white; 
    padding: 25px 30px; 
  }

  .content ul { 
    list-style: none; 
  }

  .content li {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
    gap: 15px;
  }

  .content li:last-child {
    border-bottom: none;
  }

  .plato-info {
    flex: 1;
    min-width: 0;
  }

  .dish { 
    font-weight: 600; 
    color: #1a1a1a; 
    font-size: 1.05em; 
    letter-spacing: 0.5px;
    display: block;
    margin-bottom: 4px;
  }

  .descripcion {
    font-weight: 400;
    font-size: 0.95em;
    color: #666;
    line-height: 1.4;
    margin-bottom: 6px;
  }

  .plato-derecha {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }

  .alergenos {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }

  .alergenos img {
    width: 30px;
    height: 30px;
    object-fit: contain;
    opacity: 0.9;
    transition: all 0.2s;
    background: #f9f9f9;
    border-radius: 50%;
    padding: 4px;
    border: 1px solid #eee;
  }

  .alergenos img:hover {
    opacity: 1;
    transform: scale(1.15);
    border-color: #ddd;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .precio {
    font-weight: 600;
    font-size: 1.15em;
    color: #333;
    white-space: nowrap;
    min-width: 65px;
    text-align: right;
  }

  footer { 
    text-align: center; 
    margin-top: 50px; 
    font-size: 0.85em; 
    color: #999; 
    letter-spacing: 1px; 
    position: relative; 
    z-index: 1; 
  }

  .empty-message {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    font-style: italic;
  }

  .loading {
    text-align: center;
    padding: 40px;
    color: #666;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Men√∫ üçΩÔ∏è</h1>
    <p>Carta Digital</p>
  </header>

  <main id="mainMenu">
    <div class="loading">Cargando carta...</div>
  </main>

  <footer>
    <p>¬© 2026 iCreate</p>
  </footer>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://qozzxdrjwjskmwmxscqj.supabase.co'
const supabaseKey = 'sb_publishable_UtBfupVv8e2zniYdv1jvEA_SXIyWE0Z'
const supabase = createClient(supabaseUrl, supabaseKey)

// Obtener clienteId desde query string
const params = new URLSearchParams(window.location.search)
const clienteId = params.get('cliente')

async function cargarCarta(clienteId) {
  const mainMenu = document.getElementById('mainMenu')
  
  if (!clienteId) {
    mainMenu.innerHTML = '<div class="empty-message">URL inv√°lida. Falta el par√°metro "cliente".</div>'
    return
  }

  try {
    // Cargar categor√≠as activas
    const { data: categorias, error: catError } = await supabase
      .from('Categorias')
      .select('*')
      .eq('user_id', clienteId)
      .eq('activa', true)
      .order('orden')

    if (catError) throw catError

    // Cargar platos activos
    const { data: platos, error: platosError } = await supabase
      .from('Menu')
      .select('*')
      .eq('user_id', clienteId)
      .eq('activo', true)
      .order('orden')

    if (platosError) throw platosError

    // Renderizar
    mainMenu.innerHTML = ''

    if (!categorias || categorias.length === 0) {
      mainMenu.innerHTML = '<div class="empty-message">Esta carta a√∫n no tiene contenido.</div>'
      return
    }

    categorias.forEach(categoria => {
      const platosCat = platos.filter(p => p.categoria_id == categoria.id)
      
      // Solo mostrar categor√≠as con platos
      if (platosCat.length === 0) return

      const section = document.createElement('section')
      section.className = 'menu-section'

      const button = document.createElement('button')
      button.className = 'collapsible'
      button.textContent = categoria.nombre

      const contentDiv = document.createElement('div')
      contentDiv.className = 'content'

      const ul = document.createElement('ul')

      platosCat.forEach(plato => {
        const li = document.createElement('li')
        
        let alergenosHTML = ''
        if (plato.alergenos && plato.alergenos.length > 0) {
          alergenosHTML = '<div class="alergenos">'
          plato.alergenos.forEach(alergeno => {
            alergenosHTML += `<img src="alergenos/${alergeno}.svg" alt="${alergeno}" title="${alergeno.replace('_', ' ')}">`
          })
          alergenosHTML += '</div>'
        }
        
        li.innerHTML = `
          <div class="plato-info">
            <span class="dish">${plato.plato}</span>
            ${plato.descripcion ? `<div class="descripcion">${plato.descripcion}</div>` : ''}
          </div>
          <div class="plato-derecha">
            ${alergenosHTML}
            ${plato.precio ? `<div class="precio">${parseFloat(plato.precio).toFixed(2)}‚Ç¨</div>` : ''}
          </div>
        `
        
        ul.appendChild(li)
      })

      contentDiv.appendChild(ul)
      section.appendChild(button)
      section.appendChild(contentDiv)
      mainMenu.appendChild(section)
    })

    // Funcionalidad collapsible
    document.querySelectorAll(".collapsible").forEach(btn => {
      btn.addEventListener("click", () => {
        // Cerrar otros
        document.querySelectorAll(".collapsible").forEach(otherBtn => {
          if (otherBtn !== btn) {
            otherBtn.classList.remove("active")
            otherBtn.nextElementSibling.style.display = "none"
          }
        })
        
        // Toggle actual
        btn.classList.toggle("active")
        const content = btn.nextElementSibling
        content.style.display = content.style.display === "block" ? "none" : "block"
      })
    })

  } catch (error) {
    console.error('Error cargando carta:', error)
    mainMenu.innerHTML = '<div class="empty-message">Error al cargar la carta. Por favor, intenta de nuevo m√°s tarde.</div>'
  }
}

// Cargar carta si hay clienteId
if (clienteId) {
  cargarCarta(clienteId)
} else {
  document.getElementById('mainMenu').innerHTML = '<div class="empty-message">URL inv√°lida. Agrega ?cliente=TU_USER_ID a la URL</div>'
}
</script>

</body>
</html>