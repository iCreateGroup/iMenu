<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carta Restaurante Pepito</title>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="container">

<header>
  <h1>Restaurante Pepito</h1>
  <p>Carta digital üçΩÔ∏è</p>
  <div id="auth">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Contrase√±a">
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</header>

<main>
  <section class="menu-section" id="menuDisplay">
    <button class="collapsible">Carta</button>
    <div class="content">
      <ul></ul>
    </div>
  </section>

  <section class="menu-section" id="adminPanel" style="display:none;">
    <button class="collapsible">Panel Administraci√≥n</button>
    <div class="content">
      <div id="formAdmin">
        <input type="text" id="plato" placeholder="Plato">
        <input type="text" id="descripcion" placeholder="Descripci√≥n">
        <input type="number" id="precio" placeholder="Precio" min="0" step="0.01">
        <select id="categoria">
          <option value="Entrantes">Entrantes</option>
          <option value="Primeros platos">Primeros platos</option>
          <option value="Segundos platos">Segundos platos</option>
          <option value="Postres">Postres</option>
          <option value="Bebidas">Bebidas</option>
        </select>
        <button id="addBtn">Agregar Plato</button>
      </div>
      <ul id="platosAdmin"></ul>
    </div>
  </section>

</main>

<footer>
<p>¬© 2026 Restaurante Pepito</p>
</footer>

</div>

<script type="module">
import { supabase, getMenu, login, logout, addPlato, updatePlato, deletePlato, getUser } from './js/supabase.js'

const cartaUl = document.querySelector("#menuDisplay ul")
const adminSection = document.getElementById("adminPanel")
const adminUl = document.getElementById("platosAdmin")
const categorias = ["Entrantes","Primeros platos","Segundos platos","Postres","Bebidas"]

async function cargarCarta() {
  const menu = await getMenu()
  cartaUl.innerHTML = ''
  menu.forEach(item => {
    const li = document.createElement('li')
    li.innerHTML = `
      <div class="left">
        <span class="dish">${item.plato}</span>
        ${item.descripcion ? `<span class="descripcion">${item.descripcion}</span>` : ''}
      </div>
      ${item.precio ? `<span class="precio">‚Ç¨${item.precio}</span>` : ''}
    `
    cartaUl.appendChild(li)
  })

  // Cargar panel admin
  adminUl.innerHTML = ''
  menu.forEach(item => {
    const li = document.createElement('li')
    li.innerHTML = `
      <span>${item.plato} - ${item.categoria} ${item.precio ? '‚Ç¨'+item.precio : ''}</span>
      <button data-id="${item.id}" class="editBtn">Editar</button>
      <button data-id="${item.id}" class="delBtn">Borrar</button>
    `
    adminUl.appendChild(li)
  })
}

// Collapsible
document.querySelectorAll(".collapsible").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".collapsible").forEach(otherBtn => {
      if (otherBtn !== btn) {
        otherBtn.classList.remove("active")
        otherBtn.nextElementSibling.style.display = "none"
      }
    })
    btn.classList.toggle("active")
    const content = btn.nextElementSibling
    content.style.display = content.style.display === "block" ? "none" : "block"
  })
})

// LOGIN / LOGOUT
const loginBtn = document.getElementById('loginBtn')
const logoutBtn = document.getElementById('logoutBtn')

loginBtn.addEventListener('click', async () => {
  const email = document.getElementById('email').value
  const password = document.getElementById('password').value
  const user = await login(email, password)
  if(user){
    loginBtn.style.display = 'none'
    logoutBtn.style.display = 'inline-block'
    adminSection.style.display = 'block'
    cargarCarta()
  }
})

logoutBtn.addEventListener('click', async () => {
  await logout()
  loginBtn.style.display = 'inline-block'
  logoutBtn.style.display = 'none'
  adminSection.style.display = 'none'
  cartaUl.innerHTML = ''
  adminUl.innerHTML = ''
})

// AGREGAR PLATO
document.getElementById('addBtn').addEventListener('click', async () => {
  const plato = document.getElementById('plato').value
  const descripcion = document.getElementById('descripcion').value
  const precio = document.getElementById('precio').value
  const categoria = document.getElementById('categoria').value
  if(!plato || !categoria) return alert("Nombre y categor√≠a son obligatorios")
  await addPlato(plato, descripcion, precio, categoria)
  cargarCarta()
  document.getElementById('plato').value = ''
  document.getElementById('descripcion').value = ''
  document.getElementById('precio').value = ''
})

// BORRAR / EDITAR
adminUl.addEventListener('click', async (e) => {
  const id = e.target.dataset.id
  if(e.target.classList.contains('delBtn')) {
    if(confirm('Borrar plato?')) {
      await deletePlato(id)
      cargarCarta()
    }
  } else if(e.target.classList.contains('editBtn')) {
    const li = e.target.parentElement
    const span = li.querySelector('span')
    const [nombre, resto] = span.textContent.split(' - ')
    const [categoria, precio] = resto.split(' ‚Ç¨')
    document.getElementById('plato').value = nombre
    document.getElementById('descripcion').value = '' // opcional, podr√≠as parsear
    document.getElementById('precio').value = precio || ''
    document.getElementById('categoria').value = categoria
    e.target.textContent = 'Guardar'
    e.target.classList.remove('editBtn')
    e.target.classList.add('saveBtn')
    e.target.addEventListener('click', async () => {
      await updatePlato(id,
        document.getElementById('plato').value,
        document.getElementById('descripcion').value,
        document.getElementById('precio').value,
        document.getElementById('categoria').value
      )
      cargarCarta()
    }, { once: true })
  }
})
</script>

</body>
</html>
